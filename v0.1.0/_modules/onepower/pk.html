

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>onepower.pk &mdash; onepower 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            onepower
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Usage and Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developing.html">Developing OnePower</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">onepower</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">onepower.pk</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for onepower.pk</h1><div class="highlight"><pre>
<span></span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for computing 3D power spectra using the halo model approach.</span>

<span class="sd">See section 2 of https://arxiv.org/pdf/2303.08752.pdf for details.</span>
<span class="sd">Brief description on the formalism:</span>

<span class="sd">:math:`P_{uv} = P^{\rm 2h}_{uv} + P^{\rm 1h}_{uv}` (1)</span>

<span class="sd">:math:`P^{\rm 1h}_{uv} (k) = \int_{0}^{\infty} {\rm d}M W_{u}(M, k) W_{v}(M, k) n(M)` (2)</span>

<span class="sd">:math:`P^{\rm 2h}_{uv} (k) = \int_{0}^{\infty} \int_{0}^{\infty} {\rm d}M_{1} {\rm d}M_{2} P_{\rm hh}(M_{1}, M_{2}, k) W_{u}(M_{1}, k) W_{v}(M_{2}, k) n(M_{1}) n(M_{2})` (3)</span>

<span class="sd">:math:`W_{\rm x}` are the profile of the fields, :math:`u` and :math:`v`, showing how they fit into haloes.</span>
<span class="sd">:math:`n(M)` is the halo mass function, quantifying the number of haloes of each mass, :math:`M`.</span>
<span class="sd">Integrals are taken over halo mass.</span>

<span class="sd">The halo-halo power spectrum can be written as,</span>

<span class="sd">:math:`P_{\rm hh}(M_{1},M_{2},k) = b(M_{1}) b(M_{2}) P^{\rm lin}_{\rm mm}(k) (1 + \beta_{\rm nl}(M_{1},M_{2},k))` (4)</span>

<span class="sd">In the vanilla halo model the 2-halo term is usually simplified by assuming that haloes are linearly biased with respect to matter.</span>
<span class="sd">This sets beta_nl to zero and effectively decouples the integrals. Here we allow for both options to be calculated.</span>

<span class="sd">Equation (3) then becomes:</span>

<span class="sd">:math:`P^{\rm 2h}_{uv} (k) = P^{\rm lin}_{\rm mm}(k) * [I_u * I_v + I^{\rm NL}_{uv}]` (5)</span>

<span class="sd">where :math:`I_u` and :math:`I_v` are defined as:</span>

<span class="sd">:math:`I_{\rm x} = \int_{0}^{\infty} {\rm d}M b(M) W_{\rm x}(M, k) n(M)` (6)</span>

<span class="sd">and the integral over beta_nl is</span>

<span class="sd">:math:`I^{\rm NL}_{uv} = \int_{0}^{\infty} \int_{0}^{\infty} {\rm d}M_{1} {\rm d}M_{2} b(M_{1}) b(M_{2}) \beta_{\rm nl}(M_{1},M_{2},k) W_{u}(M_{1}, k) W_{v}(M_{2}, k) n(M_{1}) n(M_{2})`  (7)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numexpr</span> <span class="k">as</span> <span class="nn">ne</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simpson</span><span class="p">,</span> <span class="n">trapezoid</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span>

<span class="kn">from</span> <span class="nn">hmf._internals._cache</span> <span class="kn">import</span> <span class="n">cached_quantity</span><span class="p">,</span> <span class="n">parameter</span>
<span class="kn">from</span> <span class="nn">hmf._internals._framework</span> <span class="kn">import</span> <span class="n">Framework</span><span class="p">,</span> <span class="n">get_mdl</span>

<span class="kn">from</span> <span class="nn">.bnl</span> <span class="kn">import</span> <span class="n">NonLinearBias</span>
<span class="kn">from</span> <span class="nn">.hmi</span> <span class="kn">import</span> <span class="n">HaloModelIngredients</span>
<span class="kn">from</span> <span class="nn">.ia</span> <span class="kn">import</span> <span class="n">SatelliteAlignment</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">poisson</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">hod</span>


<div class="viewcode-block" id="PowerSpectrumResult">
<a class="viewcode-back" href="../../_autosummary/pk/onepower.pk.PowerSpectrumResult.html#onepower.pk.PowerSpectrumResult">[docs]</a>
<span class="k">class</span> <span class="nc">PowerSpectrumResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class to attach the power spectrum outputs as atributes</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PowerSpectrumResult.__init__">
<a class="viewcode-back" href="../../_autosummary/pk/PowerSpectrumResult/onepower.pk.PowerSpectrumResult.__init__.html#onepower.pk.PowerSpectrumResult.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk_1h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pk_2h</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pk_tot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_1h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_2h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_tot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_linear_bias</span> <span class="o">=</span> <span class="n">galaxy_linear_bias</span></div>
</div>



<div class="viewcode-block" id="Spectra">
<a class="viewcode-back" href="../../_autosummary/pk/onepower.pk.Spectra.html#onepower.pk.Spectra">[docs]</a>
<span class="k">class</span> <span class="nc">Spectra</span><span class="p">(</span><span class="n">HaloModelIngredients</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute matter power spectra using the halo model approach.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    matter_power_lin : array_like, optional</span>
<span class="sd">        Linear matter power spectrum.</span>
<span class="sd">    matter_power_nl : array_like, optional</span>
<span class="sd">        Non-linear matter power spectrum.</span>
<span class="sd">    response : bool, optional</span>
<span class="sd">        Whether to calculate the resulting power spectra in response formalism.</span>
<span class="sd">    mb : float, optional</span>
<span class="sd">        Gas distribution mass pivot parameter.</span>
<span class="sd">    dewiggle : bool, optional</span>
<span class="sd">        Whether to dewiggle the power spectrum.</span>
<span class="sd">    bnl : bool, optional</span>
<span class="sd">        Whether to include non-linear bias.</span>
<span class="sd">    beta_nl : array_like, optional</span>
<span class="sd">        Non-linear bias parameter.</span>
<span class="sd">    one_halo_ktrunc : float, optional</span>
<span class="sd">        Truncation wavenumber for the 1-halo term.</span>
<span class="sd">    two_halo_ktrunc : float, optional</span>
<span class="sd">        Truncation wavenumber for the 2-halo term.</span>
<span class="sd">    hod_settings_mm : dict, optional</span>
<span class="sd">        Settings for the HOD model.</span>
<span class="sd">    hod_model : str, optional</span>
<span class="sd">        HOD model to use.</span>
<span class="sd">    hod_params : dict, optional</span>
<span class="sd">        Parameters for the HOD model.</span>
<span class="sd">    hod_settings : dict, optional</span>
<span class="sd">        Settings for the HOD model.</span>
<span class="sd">    obs_settings : dict, optional</span>
<span class="sd">        Settings for the observable.</span>
<span class="sd">    pointmass : bool, optional</span>
<span class="sd">        Whether to use point mass approximation.</span>
<span class="sd">    compute_observable : bool, optional</span>
<span class="sd">        Whether to compute observable.</span>
<span class="sd">    poisson_model : str, optional</span>
<span class="sd">        Poisson model to use.</span>
<span class="sd">    poisson_params : dict, optional</span>
<span class="sd">        Parameters for the Poisson distribution.</span>
<span class="sd">    t_eff : float, optional</span>
<span class="sd">        Effective parameter for the Fortuna model.</span>
<span class="sd">    fortuna : bool, optional</span>
<span class="sd">        Whether to use the Fortuna model.</span>
<span class="sd">    one_halo_ktrunc_ia : float, optional</span>
<span class="sd">        Truncation wavenumber for the 1-halo IA term.</span>
<span class="sd">    two_halo_ktrunc_ia : float, optional</span>
<span class="sd">        Truncation wavenumber for the 2-halo IA term.</span>
<span class="sd">    align_params : dict, optional</span>
<span class="sd">        Parameters for the alignment model.</span>
<span class="sd">    hmf_kwargs : dict</span>
<span class="sd">        Additional keyword arguments for the HaloModelIngredients.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Since all parameters have reasonable defaults, the most obvious thing to do is</span>

<span class="sd">    &gt;&gt;&gt; power = Spectra()</span>
<span class="sd">    &gt;&gt;&gt; ps.power_spectrum_mm.pk_tot</span>

<span class="sd">    Many different parameters may be passed, both models and parameters of those models.</span>
<span class="sd">    For instance:</span>

<span class="sd">    &gt;&gt;&gt; power = Spectra(z=1.0, Mmin=8, hmf_model=&quot;SMT&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ps.power_spectrum_mm.pk_1h</span>

<span class="sd">    Once instantiated, changing parameters should be done through the :meth:`update`</span>
<span class="sd">    method:</span>

<span class="sd">    &gt;&gt;&gt; power.update(hod_settings={nbins: 6})</span>
<span class="sd">    &gt;&gt;&gt; ps.power_spectrum_gm.pk_1h</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Spectra.__init__">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.__init__.html#onepower.pk.Spectra.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">matter_power_lin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">matter_power_nl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mb</span><span class="o">=</span><span class="mf">13.87</span><span class="p">,</span>
        <span class="n">dewiggle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">bnl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">beta_nl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">one_halo_ktrunc</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">two_halo_ktrunc</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">pointmass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_observable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">poisson_model</span><span class="o">=</span><span class="n">poisson</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span>
        <span class="n">poisson_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hod_model</span><span class="o">=</span><span class="n">hod</span><span class="o">.</span><span class="n">Cacciato</span><span class="p">,</span>
        <span class="n">hod_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hod_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hod_settings_mm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">obs_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">t_eff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">fortuna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">one_halo_ktrunc_ia</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">two_halo_ktrunc_ia</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span>
        <span class="n">align_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">hmf_kwargs</span>
    <span class="p">):</span>

        <span class="c1"># Call super init MUST BE DONE FIRST.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">hmf_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mb</span> <span class="o">=</span> <span class="n">mb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span> <span class="o">=</span> <span class="n">bnl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_nl</span> <span class="o">=</span> <span class="n">beta_nl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dewiggle</span> <span class="o">=</span> <span class="n">dewiggle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_lin</span> <span class="o">=</span> <span class="n">matter_power_lin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_nl</span> <span class="o">=</span> <span class="n">matter_power_nl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc</span> <span class="o">=</span> <span class="n">one_halo_ktrunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_ktrunc</span> <span class="o">=</span> <span class="n">two_halo_ktrunc</span>

        <span class="c1"># Galaxy spectra specific kwargs:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointmass</span> <span class="o">=</span> <span class="n">pointmass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_observable</span> <span class="o">=</span> <span class="n">compute_observable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poisson_model</span> <span class="o">=</span> <span class="n">poisson_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poisson_params</span> <span class="o">=</span> <span class="n">poisson_params</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hod_settings</span> <span class="o">=</span> <span class="n">hod_settings</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hod_params</span> <span class="o">=</span> <span class="n">hod_params</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hod_model</span> <span class="o">=</span> <span class="n">hod_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_settings</span> <span class="o">=</span> <span class="n">obs_settings</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hod_settings_mm</span> <span class="o">=</span> <span class="n">hod_settings_mm</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># Alignment spectra specific kwargs:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_eff</span> <span class="o">=</span> <span class="n">t_eff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span> <span class="o">=</span> <span class="n">fortuna</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc_ia</span> <span class="o">=</span> <span class="n">one_halo_ktrunc_ia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_ktrunc_ia</span> <span class="o">=</span> <span class="n">two_halo_ktrunc_ia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_params</span> <span class="o">=</span> <span class="n">align_params</span> <span class="ow">or</span> <span class="p">{}</span></div>


    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">mb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gas distribution mass pivot parameter :math:`M_{\rm b}`.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bnl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to include non-linear bias.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">beta_nl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Non-linear bias parameter :math:`\beta_{\rm nl}`.</span>

<span class="sd">        :type: array_like</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dewiggle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to dewiggle the power spectrum.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">matter_power_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Linear matter power spectrum.</span>

<span class="sd">        :type: ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">matter_power_nl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Non-linear matter power spectrum</span>

<span class="sd">        :type: ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;switch&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to calculate the resulting power spectra in response formalism.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">one_halo_ktrunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncation wavenumber for the 1-halo term.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">two_halo_ktrunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncation wavenumber for the 2-halo term.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hod_settings_mm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Settings for the HOD model.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pointmass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to use point mass approximation.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_observable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to compute observable.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">poisson_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters for the Poisson distribution.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hod_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters for the HOD model.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hod_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Settings for the HOD model.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">obs_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Settings for the observable.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fortuna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether to use the Fortuna model.</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">t_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Effective parameter for the Fortuna model.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">one_halo_ktrunc_ia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncation wavenumber for the 1-halo IA term.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">two_halo_ktrunc_ia</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncation wavenumber for the 2-halo IA term.</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">align_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters for the alignment model.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hod_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An HOD model to use</span>

<span class="sd">        :type: str or `hod.HOD` subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">get_mdl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;HOD&quot;</span><span class="p">)</span>

    <span class="nd">@parameter</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">poisson_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Poisson parameter model to use</span>

<span class="sd">        :type: str or `poisson.Poisson` subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">get_mdl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;Poisson&quot;</span><span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">_beta_nl_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the pre-calculated beta_nl values or calculates it on the fly if beta_nl == None.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            beta_nl</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_nl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_bnl</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_nl</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">_pk_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the pre-calculated linear power spectrum or uses one from hmf.</span>
<span class="sd">        Additionally it applies the dewiggle method if desired, or if</span>
<span class="sd">        HMCode2020 functionality is needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            linear power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># P(k) can be returned by hmf, together with the specified k_vec!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_lin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kh</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_lin</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;nofeedback&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dewiggle</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dewiggle_plin</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Shape of input power spectra is not equal to redshift and k-vec dimensions!&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">_pk_nl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the pre-calculated non-linear power spectrum or uses one from hmf.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            non-linear power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_nl</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="c1"># P(k) can be returned by hmf!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_power_nl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kh</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nonlinear_power</span><span class="p">,</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">,</span>
                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Shape of input power spectra is not equal to redshift and k-vec dimensions!&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">peff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the mixture of linear and non-linear power spectrum.</span>
<span class="sd">        t_eff as a ratio between the two as used in Fortuna et al. IA model in order to have better 1h to 2h transition.</span>
<span class="sd">        Only used if fortuna == True.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            effective power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_eff</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_eff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">calc_bnl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the non-linear bias using the NonLinearBias class.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The non-linear bias.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bnl</span> <span class="o">=</span> <span class="n">NonLinearBias</span><span class="p">(</span>
            <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="n">z_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">,</span>
            <span class="n">k_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">,</span>
            <span class="n">h0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span>
            <span class="n">sigma_8</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_8</span><span class="p">,</span>
            <span class="n">omega_b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_b</span><span class="p">,</span>
            <span class="n">omega_c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">omega_c</span><span class="p">,</span>
            <span class="n">omega_lambda</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span><span class="p">,</span>
            <span class="n">n_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_s</span><span class="p">,</span>
            <span class="n">w0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">bnl</span><span class="o">.</span><span class="n">bnl</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">I12</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            I12 integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_I12_integrand</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">I21</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            I21 integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_I21_integrand</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">I22</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            I22 integrand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_I22_integrand</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">hod_mm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and return the HOD model for matter-matter power spectrum.</span>
<span class="sd">        Used only to link the galaxy-galaxy and galaxy-matter power spectra to</span>
<span class="sd">        the baryon feedback model.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        object</span>
<span class="sd">            The HOD model for matter-matter power spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod_model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">and</span> <span class="n">hod</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Cacciato&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hod</span><span class="p">(</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_model</span><span class="p">,</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                <span class="n">dndlnm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="n">halo_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="n">z_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">,</span>
                <span class="n">hod_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hod_settings_mm</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hod_params</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">fstar_mm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the stellar fraction for the matter-matter power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The stellar fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod_mm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod_mm</span><span class="o">.</span><span class="n">stellar_fraction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

<div class="viewcode-block" id="Spectra.dewiggle_plin">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.dewiggle_plin.html#onepower.pk.Spectra.dewiggle_plin">[docs]</a>
    <span class="k">def</span> <span class="nf">dewiggle_plin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dewiggle the linear power spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        plin : array_like</span>
<span class="sd">            Linear power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The dewiggled power spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmaV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">,</span> <span class="n">plin</span><span class="p">)</span>
        <span class="n">ombh2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_b</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="n">ommh2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="n">pk_wig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Pk_wiggle</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">,</span> <span class="n">plin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h0</span><span class="p">,</span> <span class="n">ombh2</span><span class="p">,</span> <span class="n">ommh2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tcmb</span>
        <span class="p">)</span>
        <span class="n">plin_dw</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">plin</span>
            <span class="o">-</span> <span class="p">(</span>
                <span class="mf">1.0</span>
                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">pk_wig</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">plin_dw</span></div>


<div class="viewcode-block" id="Spectra.compute_matter_profile">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_matter_profile.html#onepower.pk.Spectra.compute_matter_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_matter_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">mean_density0</span><span class="p">,</span> <span class="n">u_dm</span><span class="p">,</span> <span class="n">fnu</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter halo profile with a correction for neutrino mass fraction.</span>

<span class="sd">        Feedback can be included through u_dm.</span>

<span class="sd">        We lower the amplitude of :math:`W(M, k, z)` in the one-halo term by the factor :math:`1-f_{\nu}`,</span>
<span class="sd">        where :math:`f_{\nu}=\Omega_{\nu}/\Omega_{\mathrm{m}}` is the neutrino mass fraction, to account for the fact that</span>
<span class="sd">        we assume that hot neutrinos cannot cluster in haloes and therefore</span>
<span class="sd">        do not contribute power to the one-halo term.</span>

<span class="sd">        Therefore :math:`W(M, k \rightarrow 0, z)=(1-f_{\nu})M/\bar{\rho}` and has units of volume.</span>
<span class="sd">        This is the same as Mead et al. 2021</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        mean_density0 : array_like</span>
<span class="sd">            Mean density at redshift zero.</span>
<span class="sd">        u_dm : array_like</span>
<span class="sd">            Dark matter profile.</span>
<span class="sd">        fnu : array_like</span>
<span class="sd">            Neutrino mass fraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter halo profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Wm_0</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="n">mean_density0</span>
        <span class="k">return</span> <span class="n">Wm_0</span> <span class="o">*</span> <span class="n">u_dm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fnu</span><span class="p">)</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">matter_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile grid in z, k, and M.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_matter_profile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_dm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnu</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">matter_profile_2h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile grid in z, k, and M.</span>
<span class="sd">        This is without the neutrino subtraction, as</span>
<span class="sd">        the hot neutrinos do not cluster in haloes</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_matter_profile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_dm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span>

<div class="viewcode-block" id="Spectra.compute_matter_profile_with_feedback">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_matter_profile_with_feedback.html#onepower.pk.Spectra.compute_matter_profile_with_feedback">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_matter_profile_with_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">mean_density0</span><span class="p">,</span> <span class="n">u_dm</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fnu</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile including feedback as modelled by hmcode2020 (eq 25 of 2009.01858).</span>

<span class="sd">        :math:`W(M, k) = [\Omega_{\rm c}/\Omega_{\rm m} + f_{\rm g}(M)] W(M, k) + f_{\star} M / \bar{\rho}`</span>

<span class="sd">        The parameter :math:`0 &lt; f_{\star} &lt; \Omega_{\rm b}/\Omega_{\rm m}` can be thought of as an effective halo stellar mass fraction.</span>

<span class="sd">        Table 4 and eq 26 of 2009.01858 defines as:</span>

<span class="sd">        :math:`f_{\star}(z) = f_{\star, 0} 10^{(z f_{\star, z})}`</span>

<span class="sd">        This profile does not have :math:`1-f_{\nu}` correction as that is already accounted for in  dm_to_matter_frac</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        mean_density0 : array_like</span>
<span class="sd">            Mean density at redshift zero.</span>
<span class="sd">        u_dm : array_like</span>
<span class="sd">            Dark matter profile.</span>
<span class="sd">        z : array_like</span>
<span class="sd">            Redshift.</span>
<span class="sd">        fnu : array_like</span>
<span class="sd">            Neutrino mass fraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile with feedback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fstar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="n">dm_to_matter_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span>
        <span class="n">f_gas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fstar</span><span class="p">)</span>

        <span class="n">Wm_0</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="n">mean_density0</span>
        <span class="n">Wm</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm_to_matter_frac</span> <span class="o">+</span> <span class="n">f_gas</span><span class="p">)</span> <span class="o">*</span> <span class="n">Wm_0</span> <span class="o">*</span> <span class="n">u_dm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fnu</span><span class="p">)</span> <span class="o">+</span> <span class="n">fstar</span> <span class="o">*</span> <span class="n">Wm_0</span>
        <span class="c1"># Wm = (dm_to_matter_frac + f_gas) * Wm_0 * u_dm + fstar * Wm_0</span>
        <span class="k">return</span> <span class="n">Wm</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">matter_profile_with_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile grid with feedback.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile grid with feedback.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_matter_profile_with_feedback</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_dm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnu</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span>

<div class="viewcode-block" id="Spectra.compute_matter_profile_with_feedback_stellar_fraction_from_obs">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_matter_profile_with_feedback_stellar_fraction_from_obs.html#onepower.pk.Spectra.compute_matter_profile_with_feedback_stellar_fraction_from_obs">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">mean_density0</span><span class="p">,</span> <span class="n">u_dm</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">fnu</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">fstar</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile using stellar fraction from observations.</span>

<span class="sd">        Using :math:`f_{\star}` from HOD/CSMF/CLF that also provides for point mass estimate when used in the</span>
<span class="sd">        GGL power spectra</span>

<span class="sd">        This profile does not have :math:`1-f_{\nu}` correction as that is already accounted for in  dm_to_matter_frac</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        mean_density0 : array_like</span>
<span class="sd">            Mean density at redshift zero.</span>
<span class="sd">        u_dm : array_like</span>
<span class="sd">            Dark matter profile.</span>
<span class="sd">        z : array_like</span>
<span class="sd">            Redshift.</span>
<span class="sd">        fnu : array_like</span>
<span class="sd">            Neutrino mass fraction.</span>
<span class="sd">        mb : float</span>
<span class="sd">            Mass parameter.</span>
<span class="sd">        fstar : array_like</span>
<span class="sd">            Stellar fraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile with feedback from observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dm_to_matter_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_c</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span>
        <span class="n">Wm_0</span> <span class="o">=</span> <span class="n">mass</span> <span class="o">/</span> <span class="n">mean_density0</span>
        <span class="n">f_gas_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fg_fit</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">fstar</span><span class="p">)</span>

        <span class="n">Wm</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm_to_matter_frac</span> <span class="o">+</span> <span class="n">f_gas_fit</span><span class="p">)</span> <span class="o">*</span> <span class="n">Wm_0</span> <span class="o">*</span> <span class="n">u_dm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fnu</span><span class="p">)</span> <span class="o">+</span> <span class="n">fstar</span> <span class="o">*</span> <span class="n">Wm_0</span>
        <span class="k">return</span> <span class="n">Wm</span></div>


<div class="viewcode-block" id="Spectra.matter_profile_with_feedback_stellar_fraction_from_obs">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.matter_profile_with_feedback_stellar_fraction_from_obs.html#onepower.pk.Spectra.matter_profile_with_feedback_stellar_fraction_from_obs">[docs]</a>
    <span class="k">def</span> <span class="nf">matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fstar</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter profile grid using stellar fraction from observations.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        fstar : array_like</span>
<span class="sd">            Stellar fraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The matter profile with feedback from observations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_dm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fnu</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mb</span><span class="p">,</span>
            <span class="n">fstar</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">one_halo_truncation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1-halo term truncation at large scales (small k)</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k_trunc : float, optional</span>
<span class="sd">            Truncation wavenumber.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
        <span class="n">k_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">k_frac</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k_frac</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">two_halo_truncation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2-halo term truncation at larger k-values (large k).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k_trunc : float, optional</span>
<span class="sd">            Truncation wavenumber.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># k_frac = k_vec/k_trunc</span>
        <span class="c1"># return 1.0 - f * (k_frac**nd)/(1.0 + k_frac**nd)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_ktrunc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
        <span class="n">k_d</span> <span class="o">=</span> <span class="mf">0.05699</span>  <span class="c1"># 0.07</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="mf">2.853</span>
        <span class="n">k_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span> <span class="o">/</span> <span class="n">k_d</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_frac</span><span class="o">**</span><span class="n">nd</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k_frac</span><span class="o">**</span><span class="n">nd</span><span class="p">)</span>
        <span class="c1"># return 0.5*(1.0+(erf(-(k_vec-k_trunc))))</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">one_halo_truncation_ia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1-halo term truncation for IA.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k_trunc : float, optional</span>
<span class="sd">            Truncation wavenumber.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc_ia</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_ktrunc_ia</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">two_halo_truncation_ia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2-halo term truncation for IA.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k_trunc : float, optional</span>
<span class="sd">            Truncation wavenumber.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_ktrunc_ia</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_ktrunc_ia</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>

<div class="viewcode-block" id="Spectra.one_halo_truncation_mead">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.one_halo_truncation_mead.html#onepower.pk.Spectra.one_halo_truncation_mead">[docs]</a>
    <span class="k">def</span> <span class="nf">one_halo_truncation_mead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma8_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1-halo term truncation in Mead et al. 2021, eq 17 and table 2.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        sigma8_in : array_like</span>
<span class="sd">            Input sigma_8 values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma8_z</span> <span class="o">=</span> <span class="n">sigma8_in</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="c1"># One-halo term damping wavenumber</span>
        <span class="n">k_star</span> <span class="o">=</span> <span class="mf">0.05618</span> <span class="o">*</span> <span class="n">sigma8_z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.013</span><span class="p">)</span>  <span class="c1"># h/Mpc</span>
        <span class="n">k_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">k_star</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">k_frac</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k_frac</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.two_halo_truncation_mead">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.two_halo_truncation_mead.html#onepower.pk.Spectra.two_halo_truncation_mead">[docs]</a>
    <span class="k">def</span> <span class="nf">two_halo_truncation_mead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma8_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2-halo term truncation in Mead et al. 2021, eq 16.</span>

<span class="sd">        As long as nd &gt; 0, the multiplicative term in square brackets is</span>
<span class="sd">        unity for k &lt;&lt; kd and (1 - f) for k &gt;&gt; kd.</span>
<span class="sd">        This damping is used instead of the regular 2-halo term integrals</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        sigma8_in : array_like</span>
<span class="sd">            Input sigma_8 values.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The truncation factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigma8_z</span> <span class="o">=</span> <span class="n">sigma8_in</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">0.2696</span> <span class="o">*</span> <span class="n">sigma8_z</span> <span class="o">**</span> <span class="p">(</span><span class="mf">0.9403</span><span class="p">)</span>
        <span class="n">k_d</span> <span class="o">=</span> <span class="mf">0.05699</span> <span class="o">*</span> <span class="n">sigma8_z</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.089</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="mf">2.853</span>
        <span class="n">k_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">k_d</span>
        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_frac</span><span class="o">**</span><span class="n">nd</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">k_frac</span><span class="o">**</span><span class="n">nd</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.transition_smoothing">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.transition_smoothing.html#onepower.pk.Spectra.transition_smoothing">[docs]</a>
    <span class="k">def</span> <span class="nf">transition_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neff</span><span class="p">,</span> <span class="n">p_1h</span><span class="p">,</span> <span class="n">p_2h</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smooth the transition between 1 and 2 halo terms, eq 23 and table 2 of Mead et al. 2021.</span>

<span class="sd">        :math:`\alpha = 1` would correspond to a standard transition.</span>

<span class="sd">        :math:`\alpha &lt; 1` smooths the transition while :math:`\alpha &gt; 1` sharpens it.</span>

<span class="sd">        :math:`\Delta^{2}(k) = k^{3}/(2 \pi^{2}) P(k)`</span>

<span class="sd">        :math:`\Delta^{2}_{\rm hmcode}(k,z) = \left({[\Delta^{2}_{\rm 2h}(k,z)]^{\alpha} +[\Delta^{2}_{\rm 1h}(k,z)]^{\alpha}} \right)^{1/{\alpha}}`</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        neff : array_like</span>
<span class="sd">            Effective spectral index.</span>
<span class="sd">        p_1h : array_like</span>
<span class="sd">            1-halo term power spectrum.</span>
<span class="sd">        p_2h : array_like</span>
<span class="sd">            2-halo term power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The smoothed power spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delta_prefac</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.875</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.603</span> <span class="o">**</span> <span class="n">neff</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">Delta_1h</span> <span class="o">=</span> <span class="n">delta_prefac</span> <span class="o">*</span> <span class="n">p_1h</span>
        <span class="n">Delta_2h</span> <span class="o">=</span> <span class="n">delta_prefac</span> <span class="o">*</span> <span class="n">p_2h</span>
        <span class="n">Delta_hmcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">Delta_1h</span><span class="o">**</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">Delta_2h</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Delta_hmcode</span> <span class="o">/</span> <span class="n">delta_prefac</span></div>


<div class="viewcode-block" id="Spectra.compute_1h_term">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_1h_term.html#onepower.pk.Spectra.compute_1h_term">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_1h_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_u</span><span class="p">,</span> <span class="n">profile_v</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dndlnm</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the 1-halo term for two fields u and v, e.g. matter, galaxy, intrinsic alignment</span>

<span class="sd">        :math:`P^{\rm 1h}_{uv}(k)= \int W_{u}(k,z,M) W_{v}(k,z,M) n(M) {\rm d}M`</span>

<span class="sd">        If the fields are the same and they correspond to discrete tracers (e.g. satellite galaxies):</span>

<span class="sd">        :math:`P^{\rm 1h}_{uv}(k)= 1/n_{x}^2 \int \langle N_{x}(M)[N_{x}(M)-1]\rangle U_{x}(k,z,M)^{2} n(M) {\rm d}M + 1/n_{x}`</span>

<span class="sd">        :math:`n_{x} = \int N_{x}(M) n(M) {\rm d}M`</span>

<span class="sd">        The shot noise term is removed as we do our measurements in real space where it only shows up</span>
<span class="sd">        at zero lag which is not measured.</span>
<span class="sd">        See eq 22 of Asgari, Mead, Heymans 2023 review paper.</span>

<span class="sd">        But for satellite galaxis we use:</span>

<span class="sd">        :math:`\langle N_{\rm sat}(N_{\rm sat}-1)\rangle = \mathcal{P} \langle N_{\rm sat}\rangle ^ {2}`:</span>

<span class="sd">        :math:`P^{\rm 1h}_{\rm ss}(k)= 1/n_{\rm s}^{2} \int \mathcal{P} \langle N_{\rm sat}\rangle ^{2} U_{\rm s}(k,z,M)^{2} n(M) {\rm d}M`</span>

<span class="sd">        and write :math:`W_u = W_v = \langle N_{\rm sat}\rangle U_{\rm s}(k,z,M) \sqrt{\mathcal{P}}/n_{\rm s}`</span>

<span class="sd">        for matter halo profile is: :math:`W_{\rm m} = (M/\rho_{\rm m}) U_{\rm m}(z,k,M)`</span>

<span class="sd">        for galaxies: :math:`W_{\rm g} = (N_{\rm g}(M)/n_{\rm g}) U_{\rm g}(z,k,M)`</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        profile_u : array_like</span>
<span class="sd">            Profile of field u.</span>
<span class="sd">        profile_v : array_like</span>
<span class="sd">            Profile of field v.</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        dndlnm : array_like</span>
<span class="sd">            Halo mass function.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The 1-halo term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">profile_u</span> <span class="o">*</span> <span class="n">profile_v</span> <span class="o">*</span> <span class="n">dndlnm</span> <span class="o">/</span> <span class="n">mass</span>
        <span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.compute_A_term">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_A_term.html#onepower.pk.Spectra.compute_A_term">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_A_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">b_dm</span><span class="p">,</span> <span class="n">dndlnm</span><span class="p">,</span> <span class="n">mean_density0</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integral over the missing haloes.</span>

<span class="sd">        This term is used to compensate for low mass haloes that are missing from the integral in the matter 2-halo term.</span>
<span class="sd">        Equation A.5 of Mead and Verde 2021, 2011.08858</span>

<span class="sd">        :math:`A(M_{\rm min}) = 1 - [1/\bar{\rho} \int_{M_{\rm min}}^{\infty} {\rm d}M M b(M) n(M)]`</span>

<span class="sd">        Here all missing mass is assumed to be in halos of minimum mass :math:`M_{\rm min} = {\rm min}(M)`</span>

<span class="sd">        This equation arises from</span>

<span class="sd">        :math:`\int_{0}^{\infty} M b(M) n(M) {\rm d}M = \bar{\rho}`.</span>

<span class="sd">        and</span>

<span class="sd">        :math:`\int_{0}^{\infty} M n(M) dM = \bar{\rho}`.</span>

<span class="sd">        This :math:`\bar{\rho}` is the mean matter density at that redshift.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        b_dm : array_like</span>
<span class="sd">            Dark matter bias.</span>
<span class="sd">        dndlnm : array_like</span>
<span class="sd">            Halo mass function.</span>
<span class="sd">        mean_density0 : array_like</span>
<span class="sd">            Mean density at redshift zero.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral over the missing haloes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">integrand_m1</span> <span class="o">=</span> <span class="n">b_dm</span> <span class="o">*</span> <span class="n">dndlnm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">mean_density0</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">simpson</span><span class="p">(</span><span class="n">integrand_m1</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Warning: Mass function/bias correction is negative!&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">A</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">missing_mass_integral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral over the missing mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral over the missing mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_A_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">missing_mass</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">A_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the integral over the missing mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral over the missing mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_mass_integral</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">Im_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the matter term in the 2-halo power spectrum, eq 35 of Asgari, Mead, Heymans 2023.</span>

<span class="sd">        2-halo term integral for matter,</span>

<span class="sd">        :math:`I_{\rm m} = \int_{0}^{infty} {\rm d}M b(M) W_{\rm m}(M,k) n(M) = \int_{0}^{\infty} {\rm d}M b(M) M/{\bar{rho} U_{rm m}(M,k) n(M)`</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the matter term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I_m_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Im_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">u_dm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">I_m_term</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span>

<div class="viewcode-block" id="Spectra.compute_Im_term">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_Im_term.html#onepower.pk.Spectra.compute_Im_term">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_Im_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">u_dm</span><span class="p">,</span> <span class="n">b_dm</span><span class="p">,</span> <span class="n">dndlnm</span><span class="p">,</span> <span class="n">mean_density0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the matter term in the 2-halo power spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        u_dm : array_like</span>
<span class="sd">            Dark matter profile.</span>
<span class="sd">        b_dm : array_like</span>
<span class="sd">            Dark matter bias.</span>
<span class="sd">        dndlnm : array_like</span>
<span class="sd">            Halo mass function.</span>
<span class="sd">        mean_density0 : array_like</span>
<span class="sd">            Mean density at redshift zero.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the matter term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">integrand_m</span> <span class="o">=</span> <span class="n">b_dm</span> <span class="o">*</span> <span class="n">dndlnm</span> <span class="o">*</span> <span class="n">u_dm</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">mean_density0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">integrand_m</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mass</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.prepare_I22_integrand">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.prepare_I22_integrand.html#onepower.pk.Spectra.prepare_I22_integrand">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_I22_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_1</span><span class="p">,</span> <span class="n">b_2</span><span class="p">,</span> <span class="n">dndlnm_1</span><span class="p">,</span> <span class="n">dndlnm_2</span><span class="p">,</span> <span class="n">B_NL_k_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the integrand for the I22 term.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        b_1 : array_like</span>
<span class="sd">            Bias for the first halo.</span>
<span class="sd">        b_2 : array_like</span>
<span class="sd">            Bias for the second halo.</span>
<span class="sd">        dndlnm_1 : array_like</span>
<span class="sd">            Halo mass function for the first halo.</span>
<span class="sd">        dndlnm_2 : array_like</span>
<span class="sd">            Halo mass function for the second halo.</span>
<span class="sd">        B_NL_k_z : array_like</span>
<span class="sd">            Non-linear bias term.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Integrand for the I22 term.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># integrand_22 = B_NL_k_z * b_1[:,:,np.newaxis,np.newaxis] * b_2[:,np.newaxis,:,np.newaxis] \</span>
        <span class="c1">#    * dn_dlnm_z_1[:,:,np.newaxis,np.newaxis] \</span>
        <span class="c1">#    * dn_dlnm_z_2[:,np.newaxis,:,np.newaxis] \</span>
        <span class="c1">#    / (mass_1[np.newaxis,:,np.newaxis,np.newaxis] * mass_2[np.newaxis,np.newaxis,:,np.newaxis])</span>

        <span class="n">b_1e</span> <span class="o">=</span> <span class="n">b_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">b_2e</span> <span class="o">=</span> <span class="n">b_2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dndlnm_1e</span> <span class="o">=</span> <span class="n">dndlnm_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dndlnm_2e</span> <span class="o">=</span> <span class="n">dndlnm_2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mass_1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mass_2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">integrand_22</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="s1">&#39;B_NL_k_z * b_1e * b_2e * dndlnm_1e * dndlnm_2e / (mass_1e * mass_2e)&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">integrand_22</span></div>


<div class="viewcode-block" id="Spectra.prepare_I12_integrand">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.prepare_I12_integrand.html#onepower.pk.Spectra.prepare_I12_integrand">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_I12_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_1</span><span class="p">,</span> <span class="n">b_2</span><span class="p">,</span> <span class="n">dndlnm_1</span><span class="p">,</span> <span class="n">dndlnm_2</span><span class="p">,</span> <span class="n">B_NL_k_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the integrand for the I12 term.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        b_1 : array_like</span>
<span class="sd">            Bias for the first halo.</span>
<span class="sd">        b_2 : array_like</span>
<span class="sd">            Bias for the second halo.</span>
<span class="sd">        dndlnm_1 : array_like</span>
<span class="sd">            Halo mass function for the first halo.</span>
<span class="sd">        dndlnm_2 : array_like</span>
<span class="sd">            Halo mass function for the second halo.</span>
<span class="sd">        B_NL_k_z : array_like</span>
<span class="sd">            Non-linear bias term.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Integrand for the I12 term.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># integrand_12 = B_NL_k_z[:,:,0,:] * b_2[:,:,np.newaxis] \</span>
        <span class="c1">#    * dn_dlnm_z_2[:,:,np.newaxis] / mass_2[np.newaxis,:,np.newaxis]</span>

        <span class="n">B_NL_k_z_e</span> <span class="o">=</span> <span class="n">B_NL_k_z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">b_2e</span> <span class="o">=</span> <span class="n">b_2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dndlnm_2e</span> <span class="o">=</span> <span class="n">dndlnm_2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mass_2e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">integrand_12</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;B_NL_k_z_e * b_2e * dndlnm_2e / mass_2e&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integrand_12</span></div>


<div class="viewcode-block" id="Spectra.prepare_I21_integrand">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.prepare_I21_integrand.html#onepower.pk.Spectra.prepare_I21_integrand">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_I21_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_1</span><span class="p">,</span> <span class="n">b_2</span><span class="p">,</span> <span class="n">dndlnm_1</span><span class="p">,</span> <span class="n">dndlnm_2</span><span class="p">,</span> <span class="n">B_NL_k_z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the integrand for the I21 term.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        b_1 : array_like</span>
<span class="sd">            Bias for the first halo.</span>
<span class="sd">        b_2 : array_like</span>
<span class="sd">            Bias for the second halo.</span>
<span class="sd">        dndlnm_1 : array_like</span>
<span class="sd">            Halo mass function for the first halo.</span>
<span class="sd">        dndlnm_2 : array_like</span>
<span class="sd">            Halo mass function for the second halo.</span>
<span class="sd">        B_NL_k_z : array_like</span>
<span class="sd">            Non-linear bias term.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Integrand for the I21 term.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># integrand_21 = B_NL_k_z[:,0,:,:] * b_1[:,:,np.newaxis] \</span>
        <span class="c1">#    * dn_dlnm_z_1[:,:,np.newaxis] / mass_1[np.newaxis,:,np.newaxis]</span>

        <span class="n">B_NL_k_z_e</span> <span class="o">=</span> <span class="n">B_NL_k_z</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">b_1e</span> <span class="o">=</span> <span class="n">b_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dndlnm_1e</span> <span class="o">=</span> <span class="n">dndlnm_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mass_1e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">integrand_21</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;B_NL_k_z_e * b_1e * dndlnm_1e / mass_1e&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integrand_21</span></div>


<div class="viewcode-block" id="Spectra.I_NL">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.I_NL.html#onepower.pk.Spectra.I_NL">[docs]</a>
    <span class="k">def</span> <span class="nf">I_NL</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">W_1</span><span class="p">,</span>
        <span class="n">W_2</span><span class="p">,</span>
        <span class="n">b_1</span><span class="p">,</span>
        <span class="n">b_2</span><span class="p">,</span>
        <span class="n">dndlnm_1</span><span class="p">,</span>
        <span class="n">dndlnm_2</span><span class="p">,</span>
        <span class="n">A</span><span class="p">,</span>
        <span class="n">rho_mean</span><span class="p">,</span>
        <span class="n">B_NL_k_z</span><span class="p">,</span>
        <span class="n">integrand_12_part</span><span class="p">,</span>
        <span class="n">integrand_21_part</span><span class="p">,</span>
        <span class="n">integrand_22_part</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the integral over beta_nl using equations A.7 to A.10 from Mead and Verde 2021.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        W_1 : array_like</span>
<span class="sd">            Profile for the first halo.</span>
<span class="sd">        W_2 : array_like</span>
<span class="sd">            Profile for the second halo.</span>
<span class="sd">        b_1 : array_like</span>
<span class="sd">            Bias for the first halo.</span>
<span class="sd">        b_2 : array_like</span>
<span class="sd">            Bias for the second halo.</span>
<span class="sd">        dndlnm_1 : array_like</span>
<span class="sd">            Halo mass function for the first halo.</span>
<span class="sd">        dndlnm_2 : array_like</span>
<span class="sd">            Halo mass function for the second halo.</span>
<span class="sd">        A : array_like</span>
<span class="sd">            Integral over the missing mass.</span>
<span class="sd">        rho_mean : array_like</span>
<span class="sd">            Mean density.</span>
<span class="sd">        B_NL_k_z : array_like</span>
<span class="sd">            Non-linear bias term.</span>
<span class="sd">        integrand_12_part : array_like</span>
<span class="sd">            Part of the integrand for the I12 term.</span>
<span class="sd">        integrand_21_part : array_like</span>
<span class="sd">            Part of the integrand for the I21 term.</span>
<span class="sd">        integrand_22_part : array_like</span>
<span class="sd">            Part of the integrand for the I22 term.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral over beta_nl.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transpose W_1 and W_2</span>
        <span class="n">W_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">W_1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">W_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">W_2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Reshape W_1 and W_2 for broadcasting</span>
        <span class="n">W_1e</span> <span class="o">=</span> <span class="n">W_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">W_2e</span> <span class="o">=</span> <span class="n">W_2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="c1"># Calculate integrand_22 using broadcasting</span>
        <span class="c1"># integrand_22 = integrand_22_part * W_1e * W_2e</span>
        <span class="n">integrand_22</span> <span class="o">=</span> <span class="n">ne</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="s1">&#39;integrand_22_part * W_1e * W_2e&#39;</span><span class="p">)</span>

        <span class="c1"># Perform trapezoidal integration</span>
        <span class="n">integral_M1</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand_22</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">integral_M2</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">integral_M1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">I_22</span> <span class="o">=</span> <span class="n">integral_M2</span>

        <span class="c1"># Calculate I_11 using broadcasting</span>
        <span class="n">I_11</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">B_NL_k_z</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])</span>
                <span class="o">*</span> <span class="n">W_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">W_2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">rho_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Calculate I_12 using broadcasting</span>
        <span class="n">integrand_12</span> <span class="o">=</span> <span class="n">integrand_12_part</span> <span class="o">*</span> <span class="n">W_2</span>
        <span class="n">integral_12</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand_12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">I_12</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">A</span> <span class="o">*</span> <span class="n">W_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">integral_12</span> <span class="o">*</span> <span class="n">rho_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Calculate I_21 using broadcasting</span>
        <span class="n">integrand_21</span> <span class="o">=</span> <span class="n">integrand_21_part</span> <span class="o">*</span> <span class="n">W_1</span>
        <span class="n">integral_21</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">integrand_21</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">I_21</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">A</span> <span class="o">*</span> <span class="n">W_2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">integral_21</span> <span class="o">*</span> <span class="n">rho_mean</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Combine all terms</span>
        <span class="n">I_NL</span> <span class="o">=</span> <span class="n">I_11</span> <span class="o">+</span> <span class="n">I_12</span> <span class="o">+</span> <span class="n">I_21</span> <span class="o">+</span> <span class="n">I_22</span>

        <span class="k">return</span> <span class="n">I_NL</span></div>


<div class="viewcode-block" id="Spectra.fg">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.fg.html#onepower.pk.Spectra.fg">[docs]</a>
    <span class="k">def</span> <span class="nf">fg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">z_vec</span><span class="p">,</span> <span class="n">fstar</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the gas fraction, eq 24 of Mead et al. 2021.</span>

<span class="sd">        :math:`f_{\rm g}(M) = [\Omega_{\rm b}/\Omega_{\rm m} - f_{\star}] (M/M_{\rm b})^{\beta}/ (1 + (M/M_{\rm b})^{\beta})`</span>

<span class="sd">        where :math:`f_{\rm g}` is the halo gas fraction, the pre-factor in parenthesis is the</span>
<span class="sd">        available gas reservoir, while :math:`M_{\rm b}` &gt; 0` and :math:`\beta &gt; 0` are fitted parameters.</span>
<span class="sd">        Haloes of :math:`M &gt;&gt; M_{\rm b}` are unaffected while those of :math:`M &lt; M_{\rm b}` have</span>
<span class="sd">        lost more than half of their gas</span>

<span class="sd">        theta_agn = log10_TAGN - 7.8</span>
<span class="sd">        table 4 of 2009.01858, units of M_sun/h</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        z_vec : array_like</span>
<span class="sd">            Redshift.</span>
<span class="sd">        fstar : array_like</span>
<span class="sd">            Stellar fraction.</span>
<span class="sd">        beta : float, optional</span>
<span class="sd">            Slope parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The gas fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta_agn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10T_AGN</span> <span class="o">-</span> <span class="mf">7.8</span>
        <span class="n">mb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">13.87</span> <span class="o">+</span> <span class="mf">1.81</span> <span class="o">*</span> <span class="n">theta_agn</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
            <span class="mf">10.0</span><span class="p">,</span> <span class="n">z_vec</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.195</span> <span class="o">*</span> <span class="n">theta_agn</span> <span class="o">-</span> <span class="mf">0.108</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">baryon_to_matter_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">baryon_to_matter_fraction</span> <span class="o">-</span> <span class="n">fstar</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="n">mb</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span>
            <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="n">mb</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.fg_fit">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.fg_fit.html#onepower.pk.Spectra.fg_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">fg_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">fstar</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the gas fraction for a general baryonic feedback model, eq 24 of Mead et al. 2021.</span>

<span class="sd">        :math:`f_{\rm g}(M) = [\Omega_{\rm b}/\Omega_{\rm m} - f_{\star}] (M/M_{\rm b})^{\beta}/ (1 + (M/M_{\rm b})^{\beta})`</span>

<span class="sd">        where :math:`f_{\rm g}` is the halo gas fraction, the pre-factor in parenthesis is the</span>
<span class="sd">        available gas reservoir, while :math:`M_{\rm b}` &gt; 0` and :math:`\beta &gt; 0` are fitted parameters.</span>
<span class="sd">        Haloes of :math:`M &gt;&gt; M_{\rm b}` are unaffected while those of :math:`M &lt; M_{\rm b}` have</span>
<span class="sd">        lost more than half of their gas</span>


<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        mb : float</span>
<span class="sd">            Mass parameter.</span>
<span class="sd">        fstar : array_like</span>
<span class="sd">            Stellar fraction.</span>
<span class="sd">        beta : float, optional</span>
<span class="sd">            Slope parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The gas fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">baryon_to_matter_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">omega_m</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">baryon_to_matter_fraction</span> <span class="o">-</span> <span class="n">fstar</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="n">mb</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span>
            <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">mass</span> <span class="o">/</span> <span class="n">mb</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.fs">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.fs.html#onepower.pk.Spectra.fs">[docs]</a>
    <span class="k">def</span> <span class="nf">fs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_vec</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the stellar fraction from table 4 and eq 26 of Mead et al. 2021.</span>

<span class="sd">        :math:`f_{\star}(z) = f_{\star, 0} 10^{(z f_{\star,z})}`</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        z_vec : array_like</span>
<span class="sd">            Redshift.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The stellar fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta_agn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10T_AGN</span> <span class="o">-</span> <span class="mf">7.8</span>
        <span class="n">fstar_0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.01</span> <span class="o">-</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">theta_agn</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="n">fstar_z</span> <span class="o">=</span> <span class="mf">0.409</span> <span class="o">+</span> <span class="mf">0.0224</span> <span class="o">*</span> <span class="n">theta_agn</span>
        <span class="k">return</span> <span class="n">fstar_0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">z_vec</span> <span class="o">*</span> <span class="n">fstar_z</span><span class="p">)</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">poisson_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the Poisson parameter for use in Pgg integrals.</span>

<span class="sd">        Can be either a scalar (P = poisson) or a power law (P = poisson x (M/M_0)^slope).</span>
<span class="sd">        Further models can be added to this function if necessary.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass array.</span>
<span class="sd">        model_parameters : dict</span>
<span class="sd">            Keyword arguments for different options.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The Poisson parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poisson_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">poisson_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">poisson_func</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_lin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the linear power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The total power spectrums.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (1, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span><span class="n">pk_tot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_mm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter-matter power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (1, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;feedback&#39;</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fstar_mm</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_2h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_2h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL</span>
            <span class="p">)</span>  <span class="c1"># * self.two_halo_truncation[np.newaxis, np.newaxis, :]</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                    <span class="n">matter_profile_1h</span><span class="p">,</span>
                    <span class="n">matter_profile_1h</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
            <span class="p">)</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_1h</span> <span class="o">+</span> <span class="n">pk_2h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">,</span> <span class="s1">&#39;nofeedback&#39;</span><span class="p">]:</span>
                <span class="n">pk_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_mead</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sigma8_z</span>
                <span class="p">)</span>
                <span class="n">pk_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                    <span class="n">matter_profile_1h</span><span class="p">,</span>
                    <span class="n">matter_profile_1h</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation_mead</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma8_z</span><span class="p">)</span>
                <span class="n">pk_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transition_smoothing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">neff</span><span class="p">,</span> <span class="n">pk_1h</span><span class="p">,</span> <span class="n">pk_2h</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pk_2h</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">)</span>
                <span class="n">pk_1h</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                        <span class="n">matter_profile_1h</span><span class="p">,</span>
                        <span class="n">matter_profile_1h</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
                <span class="p">)</span>
                <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_1h</span> <span class="o">+</span> <span class="n">pk_2h</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span> <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span> <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span> <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

    <span class="c1"># --------------------------------  Galaxy spectra specific funtions ------------------------------</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">hod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and return the HOD model.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        object</span>
<span class="sd">            The HOD model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod_model</span><span class="p">(</span>
            <span class="n">cosmo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_model</span><span class="p">,</span>
            <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
            <span class="n">dndlnm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
            <span class="n">halo_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
            <span class="n">z_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">,</span>
            <span class="n">hod_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hod_settings</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hod_params</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">fstar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the stellar fraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The stellar fraction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">stellar_fraction</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">mass_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the average mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The average mass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">avg_halo_mass_cen</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">number_density</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize and return the observable function.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        object</span>
<span class="sd">            The observable function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod_model</span>
        <span class="k">if</span> <span class="n">hod</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Cacciato&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_observable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hod</span><span class="p">(</span>
                <span class="n">cosmo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cosmo_model</span><span class="p">,</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                <span class="n">dndlnm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="n">halo_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="n">z_vec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">,</span>
                <span class="n">hod_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_settings</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">hod_params</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the observable function in correct units.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The observable function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs_func</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs_func_cen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the observable function for central galaxies in correct units.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The observable function for central galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs_func_cen</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs_func_sat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the observable function for satellite galaxies in correct units.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The observable function for satellite galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs_func_sat</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs_func_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the observable function x-axis.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The observable function x-axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">obs_func_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the redshift for the observable function.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The redshift for the observable function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">z</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">central_galaxy_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the galaxy profile for a sample of central galaxies.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The galaxy profile for central galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_c</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">hod_cen</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u_sat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:])</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">number_density_cen</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">satellite_galaxy_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the galaxy profile for a sample of satellite galaxies.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The galaxy profile for satellite galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">hod_sat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u_sat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">number_density_sat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Spectra.compute_Ig_term">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_Ig_term.html#onepower.pk.Spectra.compute_Ig_term">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_Ig_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">dndlnm</span><span class="p">,</span> <span class="n">b_m</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the galaxy term in the 2-halo power spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        profile : array_like</span>
<span class="sd">            Galaxy profile.</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        dndlnm : array_like</span>
<span class="sd">            Halo mass function.</span>
<span class="sd">        b_m : array_like</span>
<span class="sd">            Matter bias.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the galaxy term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">profile</span> <span class="o">*</span> <span class="n">b_m</span> <span class="o">*</span> <span class="n">dndlnm</span> <span class="o">/</span> <span class="n">mass</span>
        <span class="k">return</span> <span class="n">simpson</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">Ic_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the central galaxy term in the 2-halo power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the central galaxy term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Ig_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">term</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">Is_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the satellite galaxy term in the 2-halo power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the satellite galaxy term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Ig_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">term</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_gg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the galaxy-galaxy power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (n_obs_bins, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
            <span class="n">pk_ss_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_ss_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>

        <span class="n">pk_cs_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
        <span class="p">)</span>
        <span class="n">pk_ss_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">poisson_func</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
        <span class="p">)</span>

        <span class="n">pk_1h</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">pk_cs_1h</span> <span class="o">+</span> <span class="n">pk_ss_1h</span>
        <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cc_2h</span> <span class="o">+</span> <span class="n">pk_ss_2h</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">pk_cs_2h</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">pk_2h</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL</span>

        <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_1h</span> <span class="o">+</span> <span class="n">pk_2h</span>
        <span class="n">galaxy_linear_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
            <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_2h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_tot</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span>
            <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span>
            <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span>
            <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="n">galaxy_linear_bias</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_gm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the galaxy-matter power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (n_obs_bins, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;feedback&#39;</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointmass</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fstar</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_2h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_cm_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
            <span class="n">pk_sm_2h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_cm_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_sm_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="n">pk_cm_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
                <span class="n">matter_profile_1h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
        <span class="p">)</span>
        <span class="n">pk_sm_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_galaxy_profile</span><span class="p">,</span>
                <span class="n">matter_profile_1h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation</span>
        <span class="p">)</span>

        <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_cm_1h</span> <span class="o">+</span> <span class="n">pk_sm_1h</span>
        <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cm_2h</span> <span class="o">+</span> <span class="n">pk_sm_2h</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">pk_2h</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL</span>

        <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_1h</span> <span class="o">+</span> <span class="n">pk_2h</span>
        <span class="n">galaxy_linear_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_2h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_tot</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span>
            <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span>
            <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span>
            <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="n">galaxy_linear_bias</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --------------------------------  Alignment spectra specific funtions ------------------------------</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">alignment_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the aligment amplitudes and radial dependence.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        object</span>
<span class="sd">            The SatelliteAligment class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;z_vec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_vec</span><span class="p">,</span>
                <span class="s1">&#39;mass_in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">,</span>
                <span class="s1">&#39;c_in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc_cen</span><span class="p">,</span>
                <span class="s1">&#39;r_s_in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_s_cen</span><span class="p">,</span>
                <span class="s1">&#39;rvir_in&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvir_cen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;fftlog&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">SatelliteAlignment</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">align_params</span><span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">beta_cen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Beta parameter for central galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">beta_cen</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">beta_sat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Beta parameter for satellite galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">beta_sat</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">mpivot_cen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pivot mass for central galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">mpivot_cen</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">mpivot_sat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pivot mass for satellite galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">mpivot_sat</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">alignment_gi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2h alignment amplitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">alignment_gi</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">alignment_amplitude_2h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The alignment amplitude for GI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth_factor</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">alignment_amplitude_2h_II</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The alignment amplitude for II.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">growth_factor</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">C1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Linear alignment coefficient C1 multiplited with the 2h amplitude.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mf">5e-14</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_gi</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">wkm_sat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the radial alignment profile of satellite galaxies.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The radial alignment profile of satellite galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_class</span><span class="o">.</span><span class="n">upsampled_wkm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>

<div class="viewcode-block" id="Spectra.compute_central_galaxy_alignment_profile">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_central_galaxy_alignment_profile.html#onepower.pk.Spectra.compute_central_galaxy_alignment_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_central_galaxy_alignment_profile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">growth_factor</span><span class="p">,</span> <span class="n">f_c</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpivot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass_avg</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the central galaxy alignment profile.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        growth_factor : array_like</span>
<span class="sd">            Growth factor.</span>
<span class="sd">        f_c : array_like</span>
<span class="sd">            Fraction of central galaxies.</span>
<span class="sd">        C1 : array_like</span>
<span class="sd">            Amplitude of the alignment.</span>
<span class="sd">        mass : array_like</span>
<span class="sd">            Halo mass.</span>
<span class="sd">        beta : float, optional</span>
<span class="sd">            Beta parameter.</span>
<span class="sd">        mpivot : float, optional</span>
<span class="sd">            Pivot mass.</span>
<span class="sd">        mass_avg : array_like, optional</span>
<span class="sd">            Average mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The central galaxy alignment profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mpivot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mass_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass_avg</span> <span class="o">/</span> <span class="n">mpivot</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_term</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">f_c</span> <span class="o">*</span> <span class="p">(</span><span class="n">C1</span> <span class="o">/</span> <span class="n">growth_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">additional_term</span>
        <span class="p">)</span>  <span class="c1"># * scale_factor**2.0</span></div>


<div class="viewcode-block" id="Spectra.compute_satellite_galaxy_alignment_profile">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.compute_satellite_galaxy_alignment_profile.html#onepower.pk.Spectra.compute_satellite_galaxy_alignment_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_satellite_galaxy_alignment_profile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Nsat</span><span class="p">,</span> <span class="n">numdenssat</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">wkm_sat</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpivot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mass_avg</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the satellite galaxy alignment profile.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        Nsat : array_like</span>
<span class="sd">            Number of satellite galaxies.</span>
<span class="sd">        numdenssat : array_like</span>
<span class="sd">            Number density of satellite galaxies.</span>
<span class="sd">        f_s : array_like</span>
<span class="sd">            Fraction of satellite galaxies.</span>
<span class="sd">        wkm_sat : array_like</span>
<span class="sd">            wkm for satellite galaxies.</span>
<span class="sd">        beta : float, optional</span>
<span class="sd">            Beta parameter.</span>
<span class="sd">        mpivot : float, optional</span>
<span class="sd">            Pivot mass.</span>
<span class="sd">        mass_avg : array_like, optional</span>
<span class="sd">            Average mass.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The satellite galaxy alignment profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mpivot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mass_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass_avg</span> <span class="o">/</span> <span class="n">mpivot</span><span class="p">)</span> <span class="o">**</span> <span class="n">beta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_term</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">f_s</span> <span class="o">*</span> <span class="n">Nsat</span> <span class="o">*</span> <span class="n">wkm_sat</span> <span class="o">/</span> <span class="n">numdenssat</span> <span class="o">*</span> <span class="n">additional_term</span></div>


    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">central_alignment_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the grid in z, k and mass for the central alignment</span>

<span class="sd">        :math:`\frac{f_{\rm cen}}{n_{\rm cen}} N_{\rm cen} \hat{\gamma}(k,M)`</span>

<span class="sd">        where :math:`\hat{\gamma}(k,M)` is the Fourier transform of the density weighted shear, i.e. the radial dependent power law</span>
<span class="sd">        times the NFW profile, here computed by the module wkm, while gamma_1h is only the luminosity dependence factor.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The central alignment profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_central_galaxy_alignment_profile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">growth_factor</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_c</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta_cen</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpivot_cen</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_avg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">satellite_alignment_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the grid in z, k and mass for the satellite alignment</span>

<span class="sd">        :math:`\frac{f_{\rm sat}}{n_{\rm sat}} N_{\rm sat} \hat{\gamma}(k,M)`</span>

<span class="sd">        where :math:`\hat{\gamma}(k,M)` is the Fourier transform of the density weighted shear, i.e. the radial dependent power law</span>
<span class="sd">        times the NFW profile, here computed by the module wkm, while gamma_1h is only the luminosity dependence factor.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The satellite alignment profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_satellite_galaxy_alignment_profile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">hod_sat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">number_density_sat</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_s</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wkm_sat</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beta_sat</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpivot_sat</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_avg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">Ic_align_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the central galaxy alignment term in the 2-halo power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the central galaxy alignment term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I_g_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Ig_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">I_g_align</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">Is_align_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the integral for the satellite galaxy alignment term in the 2-halo power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The integral for the satellite galaxy alignment term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">I_g_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_Ig_term</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">I_g_align</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_mi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the matter-intrinsic alignment power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (n_obs_bins, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;feedback&#39;</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mead_correction</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointmass</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_with_feedback_stellar_fraction_from_obs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fstar</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matter_profile_1h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matter_profile_2h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_sm_2h</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
            <span class="n">pk_cm_2h</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_cm_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_c</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peff</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_amplitude_2h</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_sm_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_cm_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Im_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>

        <span class="n">pk_sm_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="n">matter_profile_1h</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation_ia</span>
        <span class="p">)</span>
        <span class="c1"># pk_cm_1h = (-1.0) * self.compute_1h_term(matter_profile_1h, self.central_alignment_profile, self.mass[np.newaxis, np.newaxis, np.newaxis, :], self.dndlnm[np.newaxis, :, np.newaxis, :]) * self.one_halo_truncation_ia</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_sm_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cm_2h</span> <span class="o">+</span> <span class="n">pk_sm_2h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_sm_1h</span> <span class="o">+</span> <span class="n">pk_cm_2h</span> <span class="o">+</span> <span class="n">pk_sm_2h</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_sm_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cm_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_sm_1h</span> <span class="o">+</span> <span class="n">pk_cm_2h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_sm_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cm_2h</span> <span class="o">+</span> <span class="n">pk_sm_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_sm_1h</span> <span class="o">+</span> <span class="n">pk_cm_2h</span> <span class="o">+</span> <span class="n">pk_sm_2h</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_2h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_tot</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span> <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span> <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span> <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_ii</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the intrinsic-intrinsic alignment power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (n_obs_bins, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needs Poisson parameter as well!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">I_NL_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">I_NL_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_ss_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL_ss</span>
            <span class="p">)</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL_cc</span>
            <span class="p">)</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL_cs</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hod</span><span class="o">.</span><span class="n">f_c</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peff</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_amplitude_2h_II</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_ss_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>

        <span class="n">pk_ss_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation_ia</span>
        <span class="p">)</span>
        <span class="c1"># pk_cs_1h = self.compute_1h_term(self.central_alignment_profile, self.satellite_alignment_profile, self.mass[np.newaxis, np.newaxis, np.newaxis, :], self.dndlnm[np.newaxis, :, np.newaxis, :]) * self.one_halo_truncation_ia</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_ss_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cc_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_ss_1h</span> <span class="o">+</span> <span class="n">pk_cc_2h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_ss_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cc_2h</span> <span class="o">+</span> <span class="n">pk_ss_2h</span> <span class="o">+</span> <span class="n">pk_cs_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_ss_1h</span> <span class="o">+</span> <span class="n">pk_cc_2h</span> <span class="o">+</span> <span class="n">pk_ss_2h</span> <span class="o">+</span> <span class="n">pk_cs_2h</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_2h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_tot</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span> <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span> <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span> <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

    <span class="nd">@cached_quantity</span>
    <span class="k">def</span> <span class="nf">power_spectrum_gi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the galaxy-intrinsic alignment power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        PowerSpectrumResult object</span>
<span class="sd">            The 1-halo term, 2-halo term, total power spectrum, and galaxy linear bias.</span>
<span class="sd">            Each element of PowerSpectrumResult is a 3D array with shape (n_obs_bins, n_z, n_k).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnl</span><span class="p">:</span>
            <span class="n">I_NL_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">I_NL_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">I_NL</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">halo_bias</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">A_term</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_density0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_beta_nl_array</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I12</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I21</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">I22</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL_cc</span>
            <span class="p">)</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span> <span class="o">*</span> <span class="n">I_NL_cs</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mf">1.0</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">peff</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignment_amplitude_2h</span><span class="p">[:,]</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_cc_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>
            <span class="n">pk_cs_2h</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pk_lin</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ic_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Is_align_term</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">two_halo_truncation_ia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="p">)</span>

        <span class="n">pk_cs_1h</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_1h_term</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">central_galaxy_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">satellite_alignment_profile</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dndlnm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_halo_truncation_ia</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fortuna</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_cs_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cc_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_cs_1h</span> <span class="o">+</span> <span class="n">pk_cc_2h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">=</span> <span class="n">pk_cs_1h</span>
            <span class="n">pk_2h</span> <span class="o">=</span> <span class="n">pk_cs_2h</span> <span class="o">+</span> <span class="n">pk_cc_2h</span>
            <span class="n">pk_tot</span> <span class="o">=</span> <span class="n">pk_cs_1h</span> <span class="o">+</span> <span class="n">pk_cs_2h</span> <span class="o">+</span> <span class="n">pk_cc_2h</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="n">pk_1h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_2h</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>
            <span class="n">pk_tot</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pk_nl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_spectrum_mm</span><span class="o">.</span><span class="n">pk_tot</span>

        <span class="k">return</span> <span class="n">PowerSpectrumResult</span><span class="p">(</span>
            <span class="n">pk_1h</span><span class="o">=</span><span class="n">pk_1h</span><span class="p">,</span> <span class="n">pk_2h</span><span class="o">=</span><span class="n">pk_2h</span><span class="p">,</span> <span class="n">pk_tot</span><span class="o">=</span><span class="n">pk_tot</span><span class="p">,</span> <span class="n">galaxy_linear_bias</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

    <span class="c1"># Helper functions borrowed from Alex Mead, no need to reinvent the wheel.</span>
<div class="viewcode-block" id="Spectra.Tk_EH_nowiggle">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.Tk_EH_nowiggle.html#onepower.pk.Spectra.Tk_EH_nowiggle">[docs]</a>
    <span class="k">def</span> <span class="nf">Tk_EH_nowiggle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ombh2</span><span class="p">,</span> <span class="n">ommh2</span><span class="p">,</span> <span class="n">T_CMB</span><span class="o">=</span><span class="mf">2.7255</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        No-wiggle transfer function from Eisenstein &amp; Hu (1998).</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k : array_like</span>
<span class="sd">            Wavenumber.</span>
<span class="sd">        h : float</span>
<span class="sd">            Hubble parameter.</span>
<span class="sd">        ombh2 : float</span>
<span class="sd">            Baryon density parameter times h^2.</span>
<span class="sd">        ommh2 : float</span>
<span class="sd">            Matter density parameter times h^2.</span>
<span class="sd">        T_CMB : float, optional</span>
<span class="sd">            Temperature of the CMB.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The no-wiggle transfer function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="n">ombh2</span> <span class="o">/</span> <span class="n">ommh2</span>  <span class="c1"># Baryon ratio</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">44.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">9.83</span> <span class="o">/</span> <span class="n">ommh2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">ombh2</span><span class="o">**</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Equation (26)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1.0</span>
            <span class="o">-</span> <span class="mf">0.328</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">431.0</span> <span class="o">*</span> <span class="n">ommh2</span><span class="p">)</span> <span class="o">*</span> <span class="n">rb</span>
            <span class="o">+</span> <span class="mf">0.38</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">22.3</span> <span class="o">*</span> <span class="n">ommh2</span><span class="p">)</span> <span class="o">*</span> <span class="n">rb</span><span class="o">**</span><span class="mf">2.0</span>
        <span class="p">)</span>  <span class="c1"># Equation (31)</span>

        <span class="n">Gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">ommh2</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.43</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Equation (30)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_CMB</span> <span class="o">/</span> <span class="mf">2.7</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">Gamma</span>  <span class="c1"># Equation (28)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">+</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>  <span class="c1"># Equation (29)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="mf">14.2</span> <span class="o">+</span> <span class="mf">731.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">62.5</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span>  <span class="c1"># Equation (29)</span>
        <span class="n">Tk_nw</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">C</span> <span class="o">*</span> <span class="n">q</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># Equation (29)</span>
        <span class="k">return</span> <span class="n">Tk_nw</span></div>


<div class="viewcode-block" id="Spectra.sigmaV">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.sigmaV.html#onepower.pk.Spectra.sigmaV">[docs]</a>
    <span class="k">def</span> <span class="nf">sigmaV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">power</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the dispersion from the power spectrum.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k : array_like</span>
<span class="sd">            Wavenumber array.</span>
<span class="sd">        power : array_like</span>
<span class="sd">            Power spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The dispersion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In the limit where r -&gt; 0</span>
        <span class="n">dlnk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># we multiply by k because our steps are in logk.</span>
        <span class="n">integ</span> <span class="o">=</span> <span class="n">power</span> <span class="o">*</span> <span class="n">k</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">simpson</span><span class="p">(</span><span class="n">integ</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dlnk</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Spectra.get_Pk_wiggle">
<a class="viewcode-back" href="../../_autosummary/pk/Spectra/onepower.pk.Spectra.get_Pk_wiggle.html#onepower.pk.Spectra.get_Pk_wiggle">[docs]</a>
    <span class="k">def</span> <span class="nf">get_Pk_wiggle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Pk_lin</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ombh2</span><span class="p">,</span> <span class="n">ommh2</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">T_CMB</span><span class="o">=</span><span class="mf">2.7255</span><span class="p">,</span> <span class="n">sigma_dlnk</span><span class="o">=</span><span class="mf">0.25</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the wiggle from the linear power spectrum.</span>

<span class="sd">        TODO: Should get to work for uneven log(k) spacing</span>
<span class="sd">        NOTE: https://stackoverflow.com/questions/24143320/gaussian-sum-filter-for-irregular-spaced-points</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        k : array_like</span>
<span class="sd">            Wavenumber array.</span>
<span class="sd">        Pk_lin : array_like</span>
<span class="sd">            Linear power spectrum.</span>
<span class="sd">        h : float</span>
<span class="sd">            Hubble parameter.</span>
<span class="sd">        ombh2 : float</span>
<span class="sd">            Baryon density parameter times h^2.</span>
<span class="sd">        ommh2 : float</span>
<span class="sd">            Matter density parameter times h^2.</span>
<span class="sd">        ns : float</span>
<span class="sd">            Spectral index.</span>
<span class="sd">        T_CMB : float, optional</span>
<span class="sd">            Temperature of the CMB.</span>
<span class="sd">        sigma_dlnk : float, optional</span>
<span class="sd">            Smoothing scale in log(k).</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        ndarray</span>
<span class="sd">            The wiggle component of the power spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dewiggle only works with linearly-spaced k array&#39;</span><span class="p">)</span>

        <span class="n">dlnk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_dlnk</span> <span class="o">/</span> <span class="n">dlnk</span>

        <span class="n">Pk_nowiggle</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="n">ns</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tk_EH_nowiggle</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ombh2</span><span class="p">,</span> <span class="n">ommh2</span><span class="p">,</span> <span class="n">T_CMB</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">Pk_ratio</span> <span class="o">=</span> <span class="n">Pk_lin</span> <span class="o">/</span> <span class="n">Pk_nowiggle</span>
        <span class="n">Pk_ratio</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">Pk_ratio</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">Pk_smooth</span> <span class="o">=</span> <span class="n">Pk_ratio</span> <span class="o">*</span> <span class="n">Pk_nowiggle</span>
        <span class="n">Pk_wiggle</span> <span class="o">=</span> <span class="n">Pk_lin</span> <span class="o">-</span> <span class="n">Pk_smooth</span>
        <span class="k">return</span> <span class="n">Pk_wiggle</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Andrej Dvornik.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>